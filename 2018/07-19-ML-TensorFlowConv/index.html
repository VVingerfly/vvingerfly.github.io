<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '3LK81CNDL7',
      apiKey: '1e4db2b317be6f71728401d2f4ea1a24',
      indexName: 'VVingerfly_hexo_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Convolutional Neural Network in TensorFlow">
<meta name="keywords" content="tensorflow">
<meta property="og:type" content="article">
<meta property="og:title" content="Convolutional Neural Network in TensorFlow">
<meta property="og:url" content="https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="Convolutional Neural Network in TensorFlow">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-07-19T00:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Convolutional Neural Network in TensorFlow">
<meta name="twitter:description" content="Convolutional Neural Network in TensorFlow">






  <link rel="canonical" href="https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Convolutional Neural Network in TensorFlow | Wei's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wei's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wei LI">
      <meta itemprop="description" content="好记性不如烂笔头">
      <meta itemprop="image" content="/images/avatar_heart.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Convolutional Neural Network in TensorFlow

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-19 08:00:00" itemprop="dateCreated datePublished" datetime="2018-07-19T08:00:00+08:00">2018-07-19</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/translation/" itemprop="url" rel="index"><span itemprop="name">translation</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/translation/ml/" itemprop="url" rel="index"><span itemprop="name">ml</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <a href="/2018/07-19-ML-TensorFlowConv/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07-19-ML-TensorFlowConv/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          
            <div class="post-description">Convolutional Neural Network in TensorFlow</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>翻译自<a href="https://www.tensorflow.org/tutorials/estimators/cnn" target="_blank" rel="noopener">Build a Convolutional Neural Network using Estimators</a></em></p>
<p><code>TensorFlow</code>的<code>layer</code>模块提供了一个轻松构建神经网络的高端<code>API</code>，它提供了创建稠密（全连接）层和卷积层，添加激活函数，应用<code>dropout regularization</code>的方法。本教程将介绍如何使用<code>layer</code>来构建卷积神经网络来识别<code>MNIST</code>数据集中的手写数字。</p>
<p><code>MNIST</code>数据集由<code>60,000</code>训练样例和<code>10,000</code>测试样例组成，全部都是0-9的手写数字，每个样例由<code>28x28</code>大小的图片构成。</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>首先来搭建<code>TensorFlow</code>程序的骨架，创建一个叫<code>cnn_mnist.py</code>的文件，并在其中添加下面代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="comment"># Imports</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">tf.logging.set_verbosity(tf.logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Our application logic will be added here</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  tf.app.run()</span><br></pre></td></tr></table></figure>
<p>下面的教程将指导如何在该文件中添加代码来构建、训练、评价卷积神经网络。最终完成代码可以在<a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/tutorials/layers/cnn_mnist.py" target="_blank" rel="noopener">这里下载</a>。</p>
<h2 id="Intro-to-Convolutional-Neural-Networks"><a href="#Intro-to-Convolutional-Neural-Networks" class="headerlink" title="Intro to Convolutional Neural Networks"></a>Intro to Convolutional Neural Networks</h2><p>卷积神经网络（Convolutional Neural Networks, CNNs）是图像分类任务的主流架构，CNNs通过对图像的原始像素数据作用一系列的滤波来提取并学习高阶特征，然后模型使用该特征来进行分类。CNNs包含三个部分：</p>
<ul>
<li>卷积层（Convolutional layers）：卷积层在图像上应用一定数目的卷积滤波。对于图像的每一个子区域，该层使用一些数学运算来产生输出特征图中的一个值。然后卷积层一般会继续对输出结果使用ReLU激活函数以在模型中引入非线性性。</li>
<li>池化层（Pooling layers）：池化层对卷积层提取的图像数据进行下采样，来减小特征图的维度以减少处理时间。一个广泛使用的池化算法是最大池化，最大池化提取特征图的一个子区域（如2x2的子像素块），只保留其最大值。</li>
<li>全连接层（Dense (fully connected) layers）：全连接层在通过卷积层和池化层处理后得到的特征中进行分类，在全连接层中，该层的每一个节点与下一层的每一个节点都有连接。</li>
</ul>
<p>通常，一个卷积神经网络由一堆进行特征提取的卷积模块组成，每一个模块由一个卷积层，紧接着一个池化层组成，最后一个卷积模块后面接着一个或多个全连接层来进行分类。最后一个全连接层的每一个节点对应模型目标类别中的每一个分类，并借助一个softmax激活函数来为每一个节点产生一个0到1之间的值（所有节点值的和为1），可以借助softmax得到的值来解释目标图像落在每个类别中的相对概率。</p>
<p>Note：斯坦福大学的<a href="https://cs231n.github.io/convolutional-networks/" target="_blank" rel="noopener">Convolutional Neural Networks for Visual Recognition</a>课程资料有关于CNN架构的更详细的介绍。</p>
<h2 id="Building-the-CNN-MNIST-Classifier"><a href="#Building-the-CNN-MNIST-Classifier" class="headerlink" title="Building the CNN MNIST Classifier"></a>Building the CNN MNIST Classifier</h2><p>接下来使用下面的CNN架构来构建一个模型对MNIST数据集中的图像进行分类：</p>
<ol>
<li><code>Convolutional Layer #1</code>: 应用32个5x5的滤波（提取5x5的像素块），并使用ReLU激活函数</li>
<li><code>Pooling Layer #1</code>: 使用最大池化，滤波大小为2x2，stride为2（使得被池化的区域不会重叠）</li>
<li><code>Convolutional Layer #2</code>: 应用64个5x5的滤波，并使用ReLU激活函数</li>
<li><code>Pooling Layer #2</code>: 同样，使用最大池化，滤波大小为2x2，stride为2</li>
<li><code>Dense Layer #1</code>: 1024个神经元，dropout regularization rate为0.4（在训练的过程中每个元素有0.4的概率被丢弃）</li>
<li><code>Dense Layer #2 (Logits Layer)</code>: 10个神经元，每个代表数字的类别（0到9）</li>
</ol>
<p><code>tf.layers</code>模块提供了创建这三个神经网络层的方法：</p>
<ul>
<li><code>conv2d().</code> 创建一个2维的卷积层，参数包括滤波个数，滤波核大小，padding，激活函数。</li>
<li><code>max_pooling2d().</code> 使用最大池化算法构建一个2维的池化层。参数包括池化滤波大小和strides。</li>
<li><code>dense().</code> 构建一个全连接层，参数包括神经元的个数和激活函数。</li>
</ul>
<p>这些方法的输入都是一个张量（Tensor），输出是一个变换的张量，这也使得层与层之间的连接变得简单，即只需将一层的输出当作下一层的输入。</p>
<p>打开<code>cnn_mnist.py</code>文件并添加下面符合<code>TensorFlow</code>的<code>Estimator API</code>接口的<code>cnn_model_fn</code>函数。<code>cnn_mnist.py</code>将<code>MINIST</code>特征数据、标记和模型模式（TRAIN，EVAL，PREDICT）作为参数，配置<code>CNN</code>，然后返回预测、损失和一个训练操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cnn_model_fn</span><span class="params">(features, labels, mode)</span>:</span></span><br><span class="line">  <span class="string">"""Model function for CNN."""</span></span><br><span class="line">  <span class="comment"># Input Layer</span></span><br><span class="line">  input_layer = tf.reshape(features[<span class="string">"x"</span>], [<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Convolutional Layer #1</span></span><br><span class="line">  conv1 = tf.layers.conv2d(</span><br><span class="line">      inputs=input_layer,</span><br><span class="line">      filters=<span class="number">32</span>,</span><br><span class="line">      kernel_size=[<span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">      padding=<span class="string">"same"</span>,</span><br><span class="line">      activation=tf.nn.relu)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Pooling Layer #1</span></span><br><span class="line">  pool1 = tf.layers.max_pooling2d(inputs=conv1, pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Convolutional Layer #2 and Pooling Layer #2</span></span><br><span class="line">  conv2 = tf.layers.conv2d(</span><br><span class="line">      inputs=pool1,</span><br><span class="line">      filters=<span class="number">64</span>,</span><br><span class="line">      kernel_size=[<span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">      padding=<span class="string">"same"</span>,</span><br><span class="line">      activation=tf.nn.relu)</span><br><span class="line">  pool2 = tf.layers.max_pooling2d(inputs=conv2, pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Dense Layer</span></span><br><span class="line">  pool2_flat = tf.reshape(pool2, [<span class="number">-1</span>, <span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>])</span><br><span class="line">  dense = tf.layers.dense(inputs=pool2_flat, units=<span class="number">1024</span>, activation=tf.nn.relu)</span><br><span class="line">  dropout = tf.layers.dropout(</span><br><span class="line">      inputs=dense, rate=<span class="number">0.4</span>, training=mode == tf.estimator.ModeKeys.TRAIN)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Logits Layer</span></span><br><span class="line">  logits = tf.layers.dense(inputs=dropout, units=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">  predictions = &#123;</span><br><span class="line">      <span class="comment"># Generate predictions (for PREDICT and EVAL mode)</span></span><br><span class="line">      <span class="string">"classes"</span>: tf.argmax(input=logits, axis=<span class="number">1</span>),</span><br><span class="line">      <span class="comment"># Add `softmax_tensor` to the graph. It is used for PREDICT and by the</span></span><br><span class="line">      <span class="comment"># `logging_hook`.</span></span><br><span class="line">      <span class="string">"probabilities"</span>: tf.nn.softmax(logits, name=<span class="string">"softmax_tensor"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> mode == tf.estimator.ModeKeys.PREDICT:</span><br><span class="line">    <span class="keyword">return</span> tf.estimator.EstimatorSpec(mode=mode, predictions=predictions)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Calculate Loss (for both TRAIN and EVAL modes)</span></span><br><span class="line">  loss = tf.losses.sparse_softmax_cross_entropy(labels=labels, logits=logits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Configure the Training Op (for TRAIN mode)</span></span><br><span class="line">  <span class="keyword">if</span> mode == tf.estimator.ModeKeys.TRAIN:</span><br><span class="line">    optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.001</span>)</span><br><span class="line">    train_op = optimizer.minimize(</span><br><span class="line">        loss=loss,</span><br><span class="line">        global_step=tf.train.get_global_step())</span><br><span class="line">    <span class="keyword">return</span> tf.estimator.EstimatorSpec(mode=mode, loss=loss, train_op=train_op)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Add evaluation metrics (for EVAL mode)</span></span><br><span class="line">  eval_metric_ops = &#123;</span><br><span class="line">      <span class="string">"accuracy"</span>: tf.metrics.accuracy(</span><br><span class="line">          labels=labels, predictions=predictions[<span class="string">"classes"</span>])&#125;</span><br><span class="line">  <span class="keyword">return</span> tf.estimator.EstimatorSpec(</span><br><span class="line">      mode=mode, loss=loss, eval_metric_ops=eval_metric_ops)</span><br></pre></td></tr></table></figure>
<p>下面的章节将更加详细的介绍创建每一层的<code>tf.layers</code>代码，还有怎样计算损失，配置训练操作，生成预测。熟悉CNN的可以直接跳到<code>Training and Evaluating the CNN MNIST Classifier</code>章节.</p>
<h3 id="Input-Layer"><a href="#Input-Layer" class="headerlink" title="Input Layer"></a>Input Layer</h3><p>在<code>layers</code>模块中创建二维图像数据的卷积和池化层的方法期望输入张量默认的形状是<code>[batch_size, image_height, image_width, channels]</code>，这个行为可以通过使用<code>data_format</code>参数来改变，</p>
<ul>
<li><code>batch_size.</code>在训练中进行梯度下降时使用的样例子集的大小。</li>
<li><code>image_height.</code>样例图像的高度。</li>
<li><code>image_width.</code> 样例图像的宽度。</li>
<li><code>channels.</code> 样例图像的颜色通道数。对于彩色图像，通道数是3(red, green, blue)，对于黑白图像monochrome images，通道数是1(black)。</li>
<li><code>data_format.</code> 一个字符串，<code>channels_last</code>和<code>channels_first</code>中的一个值，默认是<code>channels_last</code>，其中<code>channels_last</code>对应输入形状<code>(batch, ..., channels)</code>，<code>channels_first</code>对应输入形状<code>(batch, channels, ...)</code>。</li>
</ul>
<p>在这个例子中，<code>MNIST</code>数据集由28x28的黑白图像组成，所以输入层的目标形状是<code>[batch_size, 28, 28, 1]</code>。为了将输入的特征图转化为这个形状，可以使用下面的<code>reshape</code>操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input_layer = tf.reshape(features[<span class="string">"x"</span>], [<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br></pre></td></tr></table></figure></p>
<p>注意这里将<code>batch size</code>指定为<code>-1</code>，表示这个维度将根据<code>features[&quot;x&quot;]</code>中输入值的个数来动态计算，其他维度的大小均设置为常量。这样可以将<code>batch_size</code>当作一个可以调节的超参数。例如，如果按照5个batches传递样例，<code>features[&quot;x&quot;]</code>将包含3,920个值，输入层的形状是<code>[5, 28, 28, 1]</code>。同样，如果传递100个batches的样例，<code>features[&quot;x&quot;]</code>将包含78,400个值，输入层的形状是<code>[100, 28, 28, 1]</code>。</p>
<h3 id="Convolutional-Layer-1"><a href="#Convolutional-Layer-1" class="headerlink" title="Convolutional Layer #1"></a>Convolutional Layer #1</h3><p>在第一个卷积层，这里对输入层使用32个5x5的滤波，并使用ReLU激活函数，可以使用layers模块中的conv2d()方法来创建该层：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conv1 = tf.layers.conv2d(</span><br><span class="line">    inputs=input_layer,</span><br><span class="line">    filters=<span class="number">32</span>,</span><br><span class="line">    kernel_size=[<span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">    padding=<span class="string">"same"</span>,</span><br><span class="line">    activation=tf.nn.relu)</span><br></pre></td></tr></table></figure></p>
<p>参数<code>inputs</code>指定输入张量，形状必须是<code>[batch_size, image_height, image_width, channels]</code>。这里将第一个卷积层与形状为<code>[batch_size, 28, 28, 1]</code>的输入层<code>input_layer</code>连接。<br><em>注意</em>：当传入的参数<code>data_format=channels_first</code>时，<code>conv2d()</code>的输入张量形状必须是<code>[batch_size, channels, image_height, image_width]</code>。</p>
<p>参数<code>filters</code>指定使用滤波的数目，<code>kernel_size</code>通过<code>[height, width]</code>的形式指定滤波的维度，如果滤波的<code>height</code>和<code>width</code>的值相同，可以直接使用一个整数来设置<code>kernel_size</code>参数，如<code>kernel_size=5</code>。</p>
<p>参数<code>padding</code>指定两个枚举变量中的一个，<code>valid</code>或<code>same</code>，大小写不敏感，默认值为<code>valid</code>。如果需要输出张量与输入张量有相同的<code>height</code>和<code>width</code>值，设置<code>padding=same</code>，<code>TensorFlow</code>将在输入张量的边缘添加0值，以确保输出张量的<code>height</code>和<code>width</code>为28.（如果不设置为<code>padding</code>，在28x28的张量上进行5x5的卷积操作将产生一个24x24的张量，因为在28x28的格子上只有24x24个位置能够提取5x5的小块。）</p>
<p>参数activation指定作用在卷积输出张量上的激活函数，这里借助tf.nn.relu来指定ReLU激活函数。</p>
<p>这里通过<code>conv2d()</code>生成的输出张量的形状为<code>[batch_size, 28, 28, 32]</code>：跟输入有着同样的height和width维度，但是现在有32个通道，其来自于32个滤波。</p>
<h3 id="Pooling-Layer-1"><a href="#Pooling-Layer-1" class="headerlink" title="Pooling Layer #1"></a>Pooling Layer #1</h3><p>下面将第一个池化层连接到刚刚创建的卷积层，这里使用<code>layers</code>中的<code>max_pooling2d()</code>方法来创建一层来进行滤波大小为2x2，<code>stride</code>为2的最大池化：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool1 = tf.layers.max_pooling2d(inputs=conv1, pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<p>同样，<code>inputs</code>指定输入张量，形状是<code>[batch_size, image_height, image_width, channels]</code>，这里输入的张量是<code>conv1</code>，即第一个卷积层的输出，其形状为<code>[batch_size, 28, 28, 32]</code>。</p>
<p>注意：跟<code>conv2d()</code>一样，如果传入参数<code>data_format=channels_first</code>，<code>max_pooling2d()</code>也必须接受形状为<code>[batch_size, channels, image_height, image_width]</code>的张量。</p>
<p>参数<code>pool_size</code>指定最大池化滤波大小<code>[height, width]</code>，如果两个维度的值一样，可以直接用一个整数值代替，如p<code>ool_size=2</code>。</p>
<p>参数<code>strides</code>指定<code>stride</code>的大小。这里将<code>stride</code>设为2，表示滤波提取的子区域在height和width方向应该相差2个像素间隔（对于2x2滤波，这意味着被提取的区域都不会有交叠）。如果想为height和width设置不同的<code>stride</code>值，可以通过指定一个元组或列表如<code>stride=[3, 6]</code>来实现。</p>
<p>由<code>max_pooling2d()</code>产生的输出张量<code>pool1</code>的形状为<code>[batch_size, 14, 14, 32]</code>：这里2x2的滤波将height和width分别减少了50%。</p>
<h3 id="Convolutional-Layer-2-and-Pooling-Layer-2"><a href="#Convolutional-Layer-2-and-Pooling-Layer-2" class="headerlink" title="Convolutional Layer #2 and Pooling Layer #2"></a>Convolutional Layer #2 and Pooling Layer #2</h3><p>和之前一样，可以通过conv2d()和max_pooling2d()将第二个卷积层和池化层连接到已有的CNN上。对于第二个卷积层，这里使用64个5x5的滤波，并同样使用ReLU激活函数。对于第二个池化层，这里使用和第一个池化层同样的配置，即2x2的最大池化，stride为2。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">conv2 = tf.layers.conv2d(</span><br><span class="line">    inputs=pool1,</span><br><span class="line">    filters=<span class="number">64</span>,</span><br><span class="line">    kernel_size=[<span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">    padding=<span class="string">"same"</span>,</span><br><span class="line">    activation=tf.nn.relu)</span><br><span class="line"></span><br><span class="line">pool2 = tf.layers.max_pooling2d(inputs=conv2, pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>注意第二个卷积层将第一个池化层的输出张量作为输入，并输出张量<code>conv2</code>，<code>conv2</code>的形状为<code>[batch_size, 14, 14, 64]</code>，和<code>pool1</code>具有同样的height和width（由于<code>padding=&quot;same&quot;</code>），64个通道是由于有64个滤波作用。<br>第二个池化层将<code>conv2</code>作为输入，输出<code>pool2</code>，其形状为<code>[batch_size, 7, 7, 64]</code>。</p>
<h3 id="Dense-Layer"><a href="#Dense-Layer" class="headerlink" title="Dense Layer"></a>Dense Layer</h3><p>接下来，在当前CNN上添加一个全连接层（包括1,024个神经元，使用ReLU激活函数），以在前面卷积层和池化层提取的特征上做分类。在连接该层之前，需要将特征图pool2展开成[batch_size, features]的形状，这样该张量便只有两个维度：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool2_flat = tf.reshape(pool2, [<span class="number">-1</span>, <span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>])</span><br></pre></td></tr></table></figure></p>
<p>在上面的<code>reshape()</code>运算中，<code>-1</code>表示<code>batch_size</code>维度将根据输入数据的样例个数来动态计算，每个样例有<code>7 (pool2 height) * 7 (pool2 width) * 64 (pool2 channels)</code>个特征，因此特征的维度是7<em>7</em>64（总共3136）。输出张量<code>pool2_flat</code>的形状为<code>[batch_size, 3136]</code>。</p>
<p>现在可以通过<code>layers</code>中的<code>dense()</code>方法来连接全连接层：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dense = tf.layers.dense(inputs=pool2_flat, units=<span class="number">1024</span>, activation=tf.nn.relu)</span><br></pre></td></tr></table></figure></p>
<p>参数<code>inputs</code>指定输入张量：展开的特征图<code>pool2_flat</code>。参数<code>units</code>指定全连接层中的神经元数目。参数<code>activation</code>指定激活函数，这里同样使用<code>tf.nn.relu</code>来添加ReLU激活函数。</p>
<p>为了改进模型的结果，这里对全连接层使用<code>dropout</code>正则化，使用<code>layers</code>中的<code>dropout</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dropout = tf.layers.dropout(</span><br><span class="line">    inputs=dense, rate=<span class="number">0.4</span>, training=mode == tf.estimator.ModeKeys.TRAIN)</span><br></pre></td></tr></table></figure></p>
<p>同样，<code>inputs</code>表示输入张量，这里是全连接层的输出。参数<code>rate</code>指定dropout rate，这里使用0.4，表示在训练过程中有40%的元素会被随机丢弃。参数<code>training</code>由一个布尔值指定当前是否是训练模式。dropout只在<code>training</code>是<code>True</code>的情况下使用。这里检查传入模型函数<code>cnn_model_fn</code>的模式是否是<code>TRAIN</code>模式。</p>
<p>输出的张量<code>dropout</code>的形状是<code>[batch_size, 1024]</code>。</p>
<h4 id="Logits-Layer"><a href="#Logits-Layer" class="headerlink" title="Logits Layer"></a>Logits Layer</h4><p>神经网络的最后一层是logits layer，该层将返回预测的原始值。这里创建一个有10个神经元（每个神经元表示0-9的目标类别）的全连接层，使用默认的线性激活函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logits = tf.layers.dense(inputs=dropout, units=<span class="number">10</span>)</span><br></pre></td></tr></table></figure></p>
<p>CNN最终的输出张量<code>logits</code>的形状为<code>[batch_size, 10]</code>。</p>
<h3 id="Generate-Predictions"><a href="#Generate-Predictions" class="headerlink" title="Generate Predictions"></a>Generate Predictions</h3><p>模型的logits layer返回一个形状为<code>[batch_size, 10]</code>的张量作为预测的原始值，接下来将这些原始值转换为2种不同的格式使得模型函数能够返回：</p>
<ul>
<li>每个样例<strong>预测的类别</strong>：0-9的一个数字</li>
<li>一个样例属于每个类别的<strong>概率</strong>，如某个样例是0的概率、1的概率等等。</li>
</ul>
<p>给定一个类别，所预测的类别是logits张量所对应行中的最大值，可以通过<code>tf.argmax</code>函数找到该最大值的索引：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tf.argmax(input=logits, axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>参数<code>input</code>指定需要提取最大值的张量，即<code>logits</code>。参数<code>axis</code>指定需要寻找最大值的输入张量的轴，这里需要沿着索引为1的维度，即对应我们的预测结果来找最大值（注意张量<code>logits</code>的形状为<code>[batch_size, 10]</code>）。</p>
<p>通过使用<code>softmax</code>函数<code>tf.nn.softmax</code>从<code>logits layer</code>得到概率：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.softmax(logits, name=<span class="string">"softmax_tensor"</span>)</span><br></pre></td></tr></table></figure></p>
<p>注意：这里使用参数<code>name</code>来显示地命名这个运算为<code>softmax_tensor</code>，这样后面可以引用它。（后面要为<code>softmax</code>值设置记录（logging））</p>
<p>这里将预测结果编制进一个词典，返回一个<code>EstimatorSpec</code>对象：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">predictions = &#123;</span><br><span class="line">    <span class="string">"classes"</span>: tf.argmax(input=logits, axis=<span class="number">1</span>),</span><br><span class="line">    <span class="string">"probabilities"</span>: tf.nn.softmax(logits, name=<span class="string">"softmax_tensor"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> mode == tf.estimator.ModeKeys.PREDICT:</span><br><span class="line">  <span class="keyword">return</span> tf.estimator.EstimatorSpec(mode=mode, predictions=predictions)</span><br></pre></td></tr></table></figure></p>
<h3 id="Calculate-Loss"><a href="#Calculate-Loss" class="headerlink" title="Calculate Loss"></a>Calculate Loss</h3><p>对于训练和评价，都需要定义一个损失函数来估计模型预测的值与实际的目标类别的接近程度。对于多目标分类问题如<code>MNIST</code>，一般用交叉熵来作为损失度量。下面的代码计算模型在<code>TRAIN</code>或<code>EVAL</code>模式下的交叉熵：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loss = tf.losses.sparse_softmax_cross_entropy(labels=labels, logits=logits)</span><br></pre></td></tr></table></figure></p>
<p>张量<code>labels</code>包含样例预测索引的列表，如[1, 9, …]。<code>logits</code>包含最后一层的线性输出。函数<code>tf.losses.sparse_softmax_cross_entropy</code>从这两个输入以高效、数值稳定的方式计算softmax crossentropy，也叫categorical crossentropy或negative log-likelihood。</p>
<h3 id="Configure-the-Training-Op"><a href="#Configure-the-Training-Op" class="headerlink" title="Configure the Training Op"></a>Configure the Training Op</h3><p> 在前面的小节中，已经将<code>CNN</code>的损失定义为<code>logits</code>层和已知<code>labels</code>的softmax cross-entropy，下面配置模型在训练过程中去优化该损失函数，这里将使用0.001的学习率、随机梯度下降法作为优化算法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> mode == tf.estimator.ModeKeys.TRAIN:</span><br><span class="line">  optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.001</span>)</span><br><span class="line">  train_op = optimizer.minimize(</span><br><span class="line">      loss=loss,</span><br><span class="line">      global_step=tf.train.get_global_step())</span><br><span class="line">  <span class="keyword">return</span> tf.estimator.EstimatorSpec(mode=mode, loss=loss, train_op=train_op)</span><br></pre></td></tr></table></figure></p>
<p>注意：需要更深入地了解为<code>Estimator</code>模型函数配置训练运算，参考<a href="https://www.tensorflow.org/guide/custom_estimators#defining-the-training-op-for-the-model" target="_blank" rel="noopener">Defining the training op for the model</a>.</p>
<h3 id="Add-evaluation-metrics"><a href="#Add-evaluation-metrics" class="headerlink" title="Add evaluation metrics"></a>Add evaluation metrics</h3><p>为了在模型中增加准确度量，这里在<code>EVAL</code>模式下定义一个<code>eval_metric_ops</code>字典：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eval_metric_ops = &#123;</span><br><span class="line">    <span class="string">"accuracy"</span>: tf.metrics.accuracy(</span><br><span class="line">        labels=labels, predictions=predictions[<span class="string">"classes"</span>])&#125;</span><br><span class="line"><span class="keyword">return</span> tf.estimator.EstimatorSpec(</span><br><span class="line">    mode=mode, loss=loss, eval_metric_ops=eval_metric_ops)</span><br></pre></td></tr></table></figure></p>
<h2 id="Training-and-Evaluating-the-CNN-MNIST-Classifier"><a href="#Training-and-Evaluating-the-CNN-MNIST-Classifier" class="headerlink" title="Training and Evaluating the CNN MNIST Classifier"></a>Training and Evaluating the CNN MNIST Classifier</h2><p>MNIST CNN模型的函数已经完成，下面准备训练并评价该模型。</p>
<h3 id="Load-Training-and-Test-Data"><a href="#Load-Training-and-Test-Data" class="headerlink" title="Load Training and Test Data"></a>Load Training and Test Data</h3><p>首先载入训练和测试数据，在<code>cnn_mnist.py</code>文件中添加一个<code>main()</code>函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(unused_argv)</span>:</span></span><br><span class="line">  <span class="comment"># Load training and eval data</span></span><br><span class="line">  mnist = tf.contrib.learn.datasets.load_dataset(<span class="string">"mnist"</span>)</span><br><span class="line">  train_data = mnist.train.images <span class="comment"># Returns np.array</span></span><br><span class="line">  train_labels = np.asarray(mnist.train.labels, dtype=np.int32)</span><br><span class="line">  eval_data = mnist.test.images <span class="comment"># Returns np.array</span></span><br><span class="line">  eval_labels = np.asarray(mnist.test.labels, dtype=np.int32)</span><br></pre></td></tr></table></figure></p>
<p>这里将训练特征数据（55,000张手写数字图像的原始像素值）和训练标签（每张图像对应的从0到9的值）作为<a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.array.html" target="_blank" rel="noopener">numpy arrays</a>的形式分别存储在<code>train_data</code>和<code>train_labels</code>中。同样，评价特征数据（10,000张图像）和评价标签被分别存储在<code>eval_data</code>和<code>eval_labels</code>中。</p>
<h3 id="Create-the-Estimator"><a href="#Create-the-Estimator" class="headerlink" title="Create the Estimator"></a>Create the Estimator</h3><p>接下来为模型创建一个<code>Estimator</code>（一个进行高端模型训练、评价和推断的<code>TensorFlow</code>类）。在 <code>main()</code>中添加如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create the Estimator</span></span><br><span class="line">mnist_classifier = tf.estimator.Estimator(</span><br><span class="line">    model_fn=cnn_model_fn, model_dir=<span class="string">"/tmp/mnist_convnet_model"</span>)</span><br></pre></td></tr></table></figure></p>
<p>参数<code>model_fn</code>指定用于训练、评价和预测的模型函数，这里传入前面创建的<code>cnn_model_fn</code>函数。参数<code>model_dir</code>指定模型数据(checkpoints)存储的路径。</p>
<h3 id="Set-Up-a-Logging-Hook"><a href="#Set-Up-a-Logging-Hook" class="headerlink" title="Set Up a Logging Hook"></a>Set Up a Logging Hook</h3><p>由于<code>CNNs</code>需要花费一定的时间去训练，这里设置一些记录以能够追踪训练的过程。可以使用<code>TensorFlow</code>的<code>tf.train.SessionRunHook</code>创建一个<code>tf.train.LoggingTensorHook</code>来记录softmax layer得到的概率值。在<code>main()</code>中添加如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set up logging for predictions</span></span><br><span class="line">tensors_to_log = &#123;<span class="string">"probabilities"</span>: <span class="string">"softmax_tensor"</span>&#125;</span><br><span class="line">logging_hook = tf.train.LoggingTensorHook(</span><br><span class="line">    tensors=tensors_to_log, every_n_iter=<span class="number">50</span>)</span><br></pre></td></tr></table></figure></p>
<p>这里在<code>tensors_to_log</code>中存储想要记录的张量的字典，每个<code>key</code>是记录输出中要打印的标签，对应的标签是张量在<code>TensorFlow</code>图中的名字，这里<code>probabilities</code>可以在<code>softmax_tensor</code>中找到，前面在<code>cnn_model_fn</code>中生成概率时在softmax运算中指定的名字。</p>
<p><strong>注意</strong>：如果不显示地通过<code>name</code>参数来给一个运算命名，TensorFlow会指定一个默认的名字。通过<a href="https://www.tensorflow.org/guide/graph_viz" target="_blank" rel="noopener">TensorBoard</a>可视化运算图或者打开<a href="https://www.tensorflow.org/guide/debugger" target="_blank" rel="noopener">TensorFlow Debugger (tfdbg)</a>可以发现每个运算的名字。</p>
<p>接下来创建<code>LoggingTensorHook</code>，并将<code>tensors_to_log</code>传入<code>tensors</code>参数，这里设置<code>every_n_iter=50</code>表示在训练中每50步输出一次probabilities。</p>
<h3 id="Train-the-Model"><a href="#Train-the-Model" class="headerlink" title="Train the Model"></a>Train the Model</h3><p>接下来创建<code>train_input_fn</code>函数并在<code>mnist_classifier</code>中调用<code>train()</code>来准备训练模型。在<code>main()</code>中添加下面代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Train the model</span></span><br><span class="line">train_input_fn = tf.estimator.inputs.numpy_input_fn(</span><br><span class="line">    x=&#123;<span class="string">"x"</span>: train_data&#125;,</span><br><span class="line">    y=train_labels,</span><br><span class="line">    batch_size=<span class="number">100</span>,</span><br><span class="line">    num_epochs=<span class="keyword">None</span>,</span><br><span class="line">    shuffle=<span class="keyword">True</span>)</span><br><span class="line">mnist_classifier.train(</span><br><span class="line">    input_fn=train_input_fn,</span><br><span class="line">    steps=<span class="number">20000</span>,</span><br><span class="line">    hooks=[logging_hook])</span><br></pre></td></tr></table></figure></p>
<p>在<code>numpy_input_fn</code>的调用中，训练特征数据和标签分别被传入<code>x</code>（作为一个<code>dict</code>）和<code>y</code>。<code>batch_size</code>被设置为100，表示在每一步中模型训练100个样例批次。<code>num_epochs=None</code>表示模型会一直训练直到达到给定的步数。<code>shuffle=True</code>表示随机改组训练数据。<br>在<code>train</code>的调用中，设置<code>steps=20000</code>表示模型将会训练20,000步。将<code>logging_hook</code>传入参数<code>hooks</code>使得在训练的过程中其可以被触发。</p>
<h3 id="Evaluate-the-Model"><a href="#Evaluate-the-Model" class="headerlink" title="Evaluate the Model"></a>Evaluate the Model</h3><p>一旦训练完成，便可以计算其在<code>MNIST</code>测试集上的准确率来评价模型，这里调用<code>evaluate</code>方法来评价在<code>model_fn</code>的<code>eval_metric_ops</code>参数中指定的度量，在<code>main()</code>中添加如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Evaluate the model and print results</span></span><br><span class="line">eval_input_fn = tf.estimator.inputs.numpy_input_fn(</span><br><span class="line">    x=&#123;<span class="string">"x"</span>: eval_data&#125;,</span><br><span class="line">    y=eval_labels,</span><br><span class="line">    num_epochs=<span class="number">1</span>,</span><br><span class="line">    shuffle=<span class="keyword">False</span>)</span><br><span class="line">eval_results = mnist_classifier.evaluate(input_fn=eval_input_fn)</span><br><span class="line">print(eval_results)</span><br></pre></td></tr></table></figure></p>
<p>为了创建<code>eval_input_fn</code>，设置<code>num_epochs=1</code>，这样模型可以在每个epoch评价度量并返回结果，这里设置<code>shuffle=False</code>以在数据中依次迭代。</p>
<h2 id="Run-the-Model"><a href="#Run-the-Model" class="headerlink" title="Run the Model"></a>Run the Model</h2><p>到目前为止，CNN模型函数、Estimator、训练/评价逻辑都编码完成，接下来看看结果。运行cnn_mnist.py。</p>
<p>注意：训练CNNs非常耗时。<code>cnn_mnist.py</code>的估计完成时间取决于处理器，但在CPU上一般需要1小时以上。为了更快速地训练，可以减小传入<code>train()</code>的步数，但这会影响准确率。</p>
<p>随着模型训练，可以看到如下输出记录：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">INFO:tensorflow:loss = <span class="number">2.36026</span>, step = <span class="number">1</span></span><br><span class="line">INFO:tensorflow:probabilities = [[ <span class="number">0.07722801</span>  <span class="number">0.08618255</span>  <span class="number">0.09256398</span>, ...]]</span><br><span class="line">...</span><br><span class="line">INFO:tensorflow:loss = <span class="number">2.13119</span>, step = <span class="number">101</span></span><br><span class="line">INFO:tensorflow:global_step/sec: <span class="number">5.44132</span></span><br><span class="line">...</span><br><span class="line">INFO:tensorflow:Loss <span class="keyword">for</span> final step: <span class="number">0.553216</span>.</span><br><span class="line"></span><br><span class="line">INFO:tensorflow:Restored model <span class="keyword">from</span> /tmp/mnist_convnet_model</span><br><span class="line">INFO:tensorflow:Eval steps [<span class="number">0</span>,inf) <span class="keyword">for</span> training step <span class="number">20000.</span></span><br><span class="line">INFO:tensorflow:Input iterator <span class="keyword">is</span> exhausted.</span><br><span class="line">INFO:tensorflow:Saving evaluation summary <span class="keyword">for</span> step <span class="number">20000</span>: accuracy = <span class="number">0.9733</span>, loss = <span class="number">0.0902271</span></span><br><span class="line">&#123;<span class="string">'loss'</span>: <span class="number">0.090227105</span>, <span class="string">'global_step'</span>: <span class="number">20000</span>, <span class="string">'accuracy'</span>: <span class="number">0.97329998</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到最终在测试集上可以达到97.3%的准确率。</p>
<h2 id="Additional-Resources"><a href="#Additional-Resources" class="headerlink" title="Additional Resources"></a>Additional Resources</h2><p>To learn more about TensorFlow Estimators and CNNs in TensorFlow, see the following resources:</p>
<ul>
<li><a href="https://www.tensorflow.org/guide/custom_estimators" target="_blank" rel="noopener">Creating Estimators in tf.estimator</a> provides an introduction to the TensorFlow Estimator API. It walks through configuring an Estimator, writing a model function, calculating loss, and defining a training op.</li>
<li><a href="https://www.tensorflow.org/tutorials/images/deep_cnn" target="_blank" rel="noopener">Advanced Convolutional Neural Networks</a> walks through how to build a MNIST CNN classification model without estimators using lower-level TensorFlow operations.</li>
</ul>
<p>上次更新日期：七月 19, 2018</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.tensorflow.org/tutorials/estimators/cnn" target="_blank" rel="noopener">Build a Convolutional Neural Network using Estimators</a> </li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="Wei LI WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Wei LI Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者:  </strong>Wei LI</li>
  <li class="post-copyright-link">
    <strong>本文链接: </strong>
    
    <a href="https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/" title="Convolutional Neural Network in TensorFlow">https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明:  </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/tensorflow/" rel="tag"># tensorflow</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07-19-CG-bvh/" rel="next" title="bvh骨骼动画文件格式">
                <i class="fa fa-chevron-left"></i> bvh骨骼动画文件格式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08-18-ML-DataNormalization/" rel="prev" title="机器学习中的数据标准化">
                机器学习中的数据标准化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar_heart.JPG" alt="Wei LI">
            
              <p class="site-author-name" itemprop="name">Wei LI</p>
              <p class="site-description motion-element" itemprop="description">好记性不如烂笔头</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">77</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/VVingerfly" title="GitHub &rarr; https://github.com/VVingerfly" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:wei587me@163.com" title="E-Mail &rarr; mailto:wei587me@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Getting-Started"><span class="nav-number">1.</span> <span class="nav-text">Getting Started</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Intro-to-Convolutional-Neural-Networks"><span class="nav-number">2.</span> <span class="nav-text">Intro to Convolutional Neural Networks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Building-the-CNN-MNIST-Classifier"><span class="nav-number">3.</span> <span class="nav-text">Building the CNN MNIST Classifier</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Input-Layer"><span class="nav-number">3.1.</span> <span class="nav-text">Input Layer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Convolutional-Layer-1"><span class="nav-number">3.2.</span> <span class="nav-text">Convolutional Layer #1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pooling-Layer-1"><span class="nav-number">3.3.</span> <span class="nav-text">Pooling Layer #1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Convolutional-Layer-2-and-Pooling-Layer-2"><span class="nav-number">3.4.</span> <span class="nav-text">Convolutional Layer #2 and Pooling Layer #2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dense-Layer"><span class="nav-number">3.5.</span> <span class="nav-text">Dense Layer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Logits-Layer"><span class="nav-number">3.5.1.</span> <span class="nav-text">Logits Layer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generate-Predictions"><span class="nav-number">3.6.</span> <span class="nav-text">Generate Predictions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calculate-Loss"><span class="nav-number">3.7.</span> <span class="nav-text">Calculate Loss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-the-Training-Op"><span class="nav-number">3.8.</span> <span class="nav-text">Configure the Training Op</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-evaluation-metrics"><span class="nav-number">3.9.</span> <span class="nav-text">Add evaluation metrics</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Training-and-Evaluating-the-CNN-MNIST-Classifier"><span class="nav-number">4.</span> <span class="nav-text">Training and Evaluating the CNN MNIST Classifier</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Training-and-Test-Data"><span class="nav-number">4.1.</span> <span class="nav-text">Load Training and Test Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-the-Estimator"><span class="nav-number">4.2.</span> <span class="nav-text">Create the Estimator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Set-Up-a-Logging-Hook"><span class="nav-number">4.3.</span> <span class="nav-text">Set Up a Logging Hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Train-the-Model"><span class="nav-number">4.4.</span> <span class="nav-text">Train the Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Evaluate-the-Model"><span class="nav-number">4.5.</span> <span class="nav-text">Evaluate the Model</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-the-Model"><span class="nav-number">5.</span> <span class="nav-text">Run the Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Additional-Resources"><span class="nav-number">6.</span> <span class="nav-text">Additional Resources</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">7.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wei LI</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a></div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>





  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=65448947";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  
  
  <script id="dsq-count-scr" src="https://wei587.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://VVingerfly.github.io/2018/07-19-ML-TensorFlowConv/";
    this.page.identifier = "2018/07-19-ML-TensorFlowConv/";
    this.page.title = 'Convolutional Neural Network in TensorFlow';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://wei587.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=7.0.0"></script>



  

  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<style>
.MathJax_Display {
  overflow: auto hidden;
}
</style>

    
  


  

  

  

  

  

  

  

  

</body>
</html>
